name: listServer
on:
  workflow_call:
    secrets:
      AWS_KEY_ID:
        required: true
      AWS_ACCESS_KEY:
        required: true
      GHP_TOKEN:
        required: true
  workflow_dispatch:
jobs:
  list_server:
    runs-on: ubuntu-latest
    steps:
      - name: Create AWS config credential folder
        run: |
          mkdir -p /home/runner/.aws
          ls -ltr /home/runner/.aws

      - name: Create AWS config region file
        uses: 1arp/create-a-file-action@0.4.5
        with:
          path: '/home/runner/.aws'
          isAbsolutePath: true
          file: 'config'
          content: |
            [default]
            region = eu-west-1

      - name: Create AWS config credential file
        uses: 1arp/create-a-file-action@0.4.5
        with:
          path: '/home/runner/.aws'
          isAbsolutePath: true
          file: 'credentials'
          content: |
            [default]
            aws_access_key_id = ${{ secrets.AWS_KEY_ID }}
            aws_secret_access_key = ${{ secrets.AWS_ACCESS_KEY }}
            region = eu-west-1

      - name: List AWS servers
        env:
          GH_TOKEN: ${{ secrets.GHP_TOKEN }}
        run: |
          bonitaAwsVersion="1.8"
          keyName="presale-ci-eu-west-1"

          # get aws presales lib
          gh release download bonita-aws-${bonitaAwsVersion} \
            --repo laurentleseigneur/bonita-aws \
            --pattern "*-jar-with-dependencies.jar"
          # list servers
          java -jar bonita-aws-${bonitaAwsVersion}-jar-with-dependencies.jar \
          -c list \
          --key-name ${keyName}

      - name: Display instances table
        run: |
          python3 << 'EOF'
          import yaml, os
          from datetime import datetime, timezone

          with open("instances.yaml") as f:
              data = yaml.safe_load(f)

          instances = [i for group in (data or []) for i in (group or [])]

          def get_tag(tags, key):
              for t in (tags or []):
                  if t.get("key") == key:
                      return t.get("value", "")
              return ""

          def format_launch_time(launch_time):
              if not launch_time:
                  return "-"
              try:
                  if isinstance(launch_time, (int, float)):
                      lt = datetime.fromtimestamp(launch_time / 1000, tz=timezone.utc)
                  elif hasattr(launch_time, "tzinfo"):
                      lt = launch_time if launch_time.tzinfo else launch_time.replace(tzinfo=timezone.utc)
                  else:
                      lt = datetime.fromisoformat(str(launch_time).replace("Z", "+00:00"))
                  return lt.strftime("%Y-%m-%d %H:%M:%S")
              except Exception:
                  return str(launch_time)

          lines = [
              "## AWS Instances",
              "",
              "| Name | Status | DNS | Launch Time |",
              "|------|--------|-----|-------------|",
          ]

          def sort_key(i):
              status = (i.get("state") or {}).get("name", "")
              lt = i.get("launchTime") or 0
              return (0 if status == "running" else 1, -lt if isinstance(lt, (int, float)) else 0)

          instances.sort(key=sort_key)

          for i in instances:
              name        = get_tag(i.get("tags"), "Name") or get_tag(i.get("tags"), "bcd:stackId") or "-"
              status      = (i.get("state") or {}).get("name", "-")
              public_dns  = i.get("publicDnsName") or "-"
              private_dns = i.get("privateDnsName") or "-"
              dns         = f"{public_dns}<br>{private_dns}"
              launch      = format_launch_time(i.get("launchTime"))
              lines.append(f"| {name} | {status} | {dns} | {launch} |")

          if not instances:
              lines.append("| — | No instances found | — | — |")

          summary = os.environ.get("GITHUB_STEP_SUMMARY")
          with open(summary, "a") as f:
              f.write("\n".join(lines) + "\n")
          EOF
