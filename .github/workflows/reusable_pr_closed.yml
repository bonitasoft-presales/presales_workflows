name: PR Closed Reusable action

on:
  workflow_call:
    inputs:
      repository_name:
        description: 'Repository name (e.g., owner/repo)'
        required: true
        type: string
      pr_number:
        description: 'PR number'
        required: true
        type: number
      pr_title:
        description: 'PR title'
        required: true
        type: string
      pr_merged:
        description: 'Whether the PR was merged'
        required: true
        type: boolean
      pr_base_ref:
        description: 'Base branch'
        required: true
        type: string
      pr_head_ref:
        description: 'Head branch'
        required: true
        type: string
      pr_actor_login:
        description: 'User who merged or closed the PR'
        required: true
        type: string
      pr_merge_commit_sha:
        description: 'Merge commit SHA (empty if not merged)'
        required: false
        type: string
        default: ''
      aws_region:
        description: 'AWS region'
        type: string
        required: false
        default: 'eu-west-1'
      key_name:
        description: 'AWS key pair name'
        type: string
        required: false
        default: 'presale-ci-eu-west-1'
      bonita_aws_version:
        description: 'Version of bonita-aws library'
        type: string
        required: false
        default: '1.8'
    secrets:
      JFROG_USER:
        required: true
      JFROG_TOKEN:
        required: true
      GHP_USER:
        required: true
      GHP_TOKEN:
        required: true
      AWS_KEY_ID:
        required: true
      AWS_ACCESS_KEY:
        required: true

jobs:
  if_merged:
    if: inputs.pr_merged == true
    runs-on: ubuntu-latest
    steps:
      - name: PR was merged
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âœ… Pull Request Merged

          | Property | Value |
          |----------|-------|
          | **Repository** | ${{ inputs.repository_name }} |
          | **PR Number** | #${{ inputs.pr_number }} |
          | **PR Title** | ${{ inputs.pr_title }} |
          | **Merged by** | @${{ inputs.pr_actor_login }} |
          | **Base branch** | \`${{ inputs.pr_base_ref }}\` |
          | **Head branch** | \`${{ inputs.pr_head_ref }}\` |
          | **Merge commit SHA** | \`${{ inputs.pr_merge_commit_sha }}\` |
          EOF

  if_closed_without_merge:
    if: inputs.pr_merged == false
    runs-on: ubuntu-latest
    steps:
      - name: PR was closed without merging
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âŒ Pull Request Closed Without Merging

          | Property | Value |
          |----------|-------|
          | **Repository** | ${{ inputs.repository_name }} |
          | **PR Number** | #${{ inputs.pr_number }} |
          | **PR Title** | ${{ inputs.pr_title }} |
          | **Closed by** | @${{ inputs.pr_actor_login }} |
          | **Base branch** | \`${{ inputs.pr_base_ref }}\` |
          | **Head branch** | \`${{ inputs.pr_head_ref }}\` |
          | **Status** | Closed without merging (possibly rejected or abandoned) |
          EOF
  delete_server:
    runs-on: ubuntu-latest
    outputs:
      aws_public_dns: ${{ steps.read-yaml.outputs.publicDnsName }}
      stack_id: ${{ steps.aws_stack_id.outputs.stackId }}
      pr_identifier: ${{ steps.pr_identifier.outputs.pr_id }}
    steps:
      - name: Split repository name into owner and repo
        id: split_repo
        run: |
          REPO_NAME="${{ inputs.repository_name }}"
          OWNER="${REPO_NAME%%/*}"
          REPO="${REPO_NAME#*/}"
          echo "owner=${OWNER}" >> $GITHUB_OUTPUT
          echo "repo=${REPO}" >> $GITHUB_OUTPUT
          echo "Repository owner: ${OWNER}"
          echo "Repository name: ${REPO}"

      - name: Generate PR identifier
        id: pr_identifier
        run: |
          REPO="${{ steps.split_repo.outputs.repo }}"
          PR_NUMBER="${{ inputs.pr_number }}"
          PR_ID="${REPO}_${PR_NUMBER}-merge"
          echo "pr_id=${PR_ID}" >> $GITHUB_OUTPUT
          echo "PR Identifier: ${PR_ID}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Setup maven private repositories
        uses: whelk-io/maven-settings-xml-action@v22
        with:
          repositories: >
            [
              {
                "id": "bar",
                "name": "Bonita Artifact Repository",
                "url": "https://bonitasoft.jfrog.io/artifactory/releases",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "false"
                }
              },
              {
                "id": "github-presales",
                "name": "github-presales",
                "url": "https://maven.pkg.github.com/bonitasoft-presales/*",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "true"
                }
              },
              {
                "id": "github-laurent",
                "name": "github-presales",
                "url": "https://maven.pkg.github.com/laurentleseigneur/*",
                "releases": {
                 "enabled": "true"
                },
                "snapshots": {
                 "enabled": "true"
                }
              }
            ]
          plugin_repositories: >
            [
              {
                "id": "bar",
                "name": "Bonita Artifact Repository",
                "url": "https://bonitasoft.jfrog.io/artifactory/releases",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "false"
                }
              }
            ]
          servers: >
            [
              {
                "id": "bar",
                "username": "${{ secrets.JFROG_USER }}",
                "password": "${{ secrets.JFROG_TOKEN }}"
              },
              {
                "id": "github-presales",
                "username": "${{ secrets.GHP_USER }}",
                "password": "${{ secrets.GHP_TOKEN }}"
              },
              {
                "id": "github-laurent",
                "username": "${{ secrets.GHP_USER }}",
                "password": "${{ secrets.GHP_TOKEN }}"
              }
            ]

      - name: Create AWS config credential folder
        run: |
          mkdir -p /home/runner/.aws
          ls -ltr /home/runner/.aws

      - name: Create AWS config region file
        uses: 1arp/create-a-file-action@0.4.5
        with:
          path: '/home/runner/.aws'
          isAbsolutePath: true
          file: 'config'
          content: |
            [default]
            region = ${{ inputs.aws_region }}

      - name: Create AWS config credential file
        uses: 1arp/create-a-file-action@0.4.5
        with:
          path: '/home/runner/.aws'
          isAbsolutePath: true
          file: 'credentials'
          content: |
            [default]
            aws_access_key_id = ${{ secrets.AWS_KEY_ID }}
            aws_secret_access_key = ${{ secrets.AWS_ACCESS_KEY }}
            region = ${{ inputs.aws_region }}

      - name: Set AWS stack ID
        id: aws_stack_id
        run: |
          OWNER="${{ steps.split_repo.outputs.owner }}"
          REPO="${{ steps.split_repo.outputs.repo }}"
          PR_ID="${{ steps.pr_identifier.outputs.pr_id }}"
          echo "stackId=${PR_ID}" >> $GITHUB_OUTPUT

          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ### ðŸ·ï¸ AWS Stack ID

          | Property | Value |
          |----------|-------|
          | **Owner** | \`${OWNER}\` |
          | **Repository** | \`${REPO}\` |
          | **PR Number** | #${{ inputs.pr_number }} |
          | **Branch** | \`${{ inputs.pr_head_ref }}\` |
          | **Stack ID (PR-based)** | \`${PR_ID}\` |
          EOF

      - name: Get AWS lib
        run: |
          # get aws presales lib
          ./mvnw --batch-mode --no-transfer-progress dependency:copy -Dartifact=com.bonitasoft.presales.aws:bonita-aws:${{ inputs.bonita_aws_version }}:jar:jar-with-dependencies -DoutputDirectory=.

      - name: Status of AWS server
        run: |
          java -jar bonita-aws-${{ inputs.bonita_aws_version }}-jar-with-dependencies.jar \
          -c status \
          --stack-id ${{ steps.pr_identifier.outputs.pr_id }} \
          --key-name ${{ inputs.key_name }}

      - name: Delete AWS server
        run: |
          java -jar bonita-aws-${{ inputs.bonita_aws_version }}-jar-with-dependencies.jar \
          -c delete \
          --stack-id ${{ steps.pr_identifier.outputs.pr_id }} \
          --key-name ${{ inputs.key_name }} \
