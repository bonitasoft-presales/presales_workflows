name: deployUib
on:
  workflow_call:
jobs:
  deploy_UIB:
    runs-on: ubuntu-latest
    env:
      AWS_PUBLIC_DNS_HOSTNAME:
      COOKIES:
      ZIP_TO_DEPLOY:
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # comes from create server
      - name: Download artifact instance.yaml file
        uses: actions/download-artifact@v4
        with:
          name: aws_instance

      - name: read-yaml-file
        uses: pietrobolcato/action-read-yaml@1.1.0
        id: read-yaml-file
        with:
          config: ${{ github.workspace }}/aws_instance.yaml

      - name: set AWS_PUBLIC_DNS_HOSTNAME env variable
        id: set-env-variable
        run: |
          echo "AWS_PUBLIC_DNS_HOSTNAME=${{ steps.read-yaml-file.outputs['publicDnsName'] }}" >> $GITHUB_ENV 

      - name: display AWS_PUBLIC_DNS_HOSTNAME env variable
        id: display-env-variable
        run: |
          echo "AWS_PUBLIC_DNS_HOSTNAME: [${AWS_PUBLIC_DNS_HOSTNAME}]" 


      - name: prepare UIB applications
        id: zip-applications
        run: |
          rm -rf ${UIB_FOLDER}
          mkdir -p ${UIB_FOLDER}
          ls -ltr "${PROJECT_FOLDER}/uib"
          find "${PROJECT_FOLDER}/uib" -type f -name "*.json" -exec zip "${UIB_FOLDER}/uib_applications.zip" -j {} +
          unzip -l "${UIB_FOLDER}/uib_applications.zip"
          ZIP_FILE="${UIB_FOLDER}/uib_applications.zip"
          echo "deploy zip applications: ${ZIP_FILE}"
          echo "ZIP_TO_DEPLOY=${ZIP_FILE}" >> $GITHUB_ENV
        env:
          PROJECT_FOLDER: "${{ github.workspace }}"
          UIB_FOLDER: "${{ github.workspace }}/temp_ui_builder"


      # Active les logs détaillés
      - name: Enable step debug
        run: echo "ACTIONS_STEP_DEBUG=true" >> $GITHUB_ENV



      - name: login
        id: loginBonita
        uses: fjogeleit/http-request-action@v1.16.4
        with:
          url: "http://${{ env.AWS_PUBLIC_DNS_HOSTNAME }}/bonita/loginservice"
          method: 'POST'
          customHeaders: '{"Content-Type": "application/x-www-form-urlencoded"}'
          data: 'username=install&password=install&redirect=false&redirectURL='

      - name: setup cookies from login Response
        run: |
          echo ${{ steps.loginBonita.outputs.response }}
          echo ${{ steps.loginBonita.outputs.headers }}
          echo ${{ steps.loginBonita.outputs.status }}
          
          cookie=$(echo '${{ steps.loginBonita.outputs.headers }}' \
          | jq -r '."set-cookie"[]' \
          | cut -d';' -f1 \
          | tr '\n' '\r' \
          | sed 's/\r/; /g' \
          | sed 's/; $//')
          echo "*** ${cookie} ***"
          
          echo "COOKIES=$cookie" >> $GITHUB_ENV


      - name: cleanup
        id: cleanup
        uses: fjogeleit/http-request-action@v1.16.4
        with:
          url: "http://${{ env.AWS_PUBLIC_DNS_HOSTNAME }}/uib/api/v1/applications/all"
          method: 'DELETE'
          customHeaders: '{"x-requested-by": "Appsmith", "Cookie":"${{ env.COOKIES }}"}'


      - name: Show cleanup Response
        run: |
          echo ${{ steps.cleanup.outputs.response }}
          echo ${{ steps.cleanup.outputs.headers }}
          echo ${{ steps.cleanup.outputs.status }}


      - name: deployJson
        id: deployJson
        uses: fjogeleit/http-request-action@v1.16.4
        with:
          url: "http://${{ env.AWS_PUBLIC_DNS_HOSTNAME }}/uib/api/v1/applications/import"
          method: 'POST'
          customHeaders: '{"Content-Type": " multipart/form-data","x-requested-by": "Appsmith", "Cookie":"${{ env.COOKIES }}"}'
          files: '{ "file": "${{ github.workspace }}/uib/Team-Management.json" }'
          responseFile: "${{ github.workspace }}/response.json"
          ignoreStatusCodes: '500'

      - name: Output responseFile
        id: execution-response-file
        run: |
          cat ${{ github.workspace }}/response.json




      - name: Show deploy Response
        run: |
          echo ${{ steps.deployJson.outputs.response }}
          echo ${{ steps.deployJson.outputs.headers }}
          echo ${{ steps.deployJson.outputs.status }}


      - name: deploy
        id: deploy
        uses: fjogeleit/http-request-action@v1.16.4
        with:
          url: "http://${{ env.AWS_PUBLIC_DNS_HOSTNAME }}/uib/api/v1/applications/import-bulk"
          method: 'POST'
          customHeaders: '{"Content-Type": " multipart/form-data","x-requested-by": "Appsmith", "Cookie":"${{ env.COOKIES }}"}'
          file: ${{ env.ZIP_TO_DEPLOY }}

      - name: Show deploy Response
        run: |
          echo ${{ steps.deploy.outputs.response }}
          echo ${{ steps.deploy.outputs.headers }}
          echo ${{ steps.deploy.outputs.status }}
