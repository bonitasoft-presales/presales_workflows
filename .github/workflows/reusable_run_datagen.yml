name: runDataGeneration
on:
  workflow_call:
    inputs:
      datagen_folder:
        required: false
        type: string
        default: "datagen"
        description: "Folder containing data generation Maven project"
      bonita_dns:
        required: false
        type: string
        description: "Bonita server DNS name (defaults to AWS instance DNS if not provided)"
      bonita_port:
        required: false
        type: string
        default: "8081"
        description: "Bonita server port"
      smtp_server:
        required: false
        type: string
        default: "greenmail"
        description: "SMTP server hostname for email testing"
      smtp_port:
        required: false
        type: string
        default: "3025"
        description: "SMTP server port for email testing"
    secrets:
      JFROG_USER:
        required: true
      JFROG_TOKEN:
        required: true
      GHP_USER:
        required: true
      GHP_TOKEN:
        required: true
      SF_USERNAME:
        required: false
      SF_PASSWORD:
        required: false
      SF_TOKEN:
        required: false
      OPENAI_API_KEY:
        required: false
jobs:
  run_data_generation:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Setup maven private repositories
        uses: whelk-io/maven-settings-xml-action@v22
        with:
          repositories: >
            [
              {
                "id": "bar",
                "name": "Bonita Artifact Repository",
                "url": "https://bonitasoft.jfrog.io/artifactory/releases",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "false"
                }
              },
              {
                "id": "github-presales",
                "name": "github-presales",
                "url": "https://maven.pkg.github.com/bonitasoft-presales/*",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "true"
                }
              },
              {
                "id": "github-laurent",
                "name": "github-presales",
                "url": "https://maven.pkg.github.com/laurentleseigneur/*",
                "releases": {
                 "enabled": "true"
                },
                "snapshots": {
                 "enabled": "true"
                }
              }
            ]
          plugin_repositories: >
            [
              {
                "id": "bar",
                "name": "Bonita Artifact Repository",
                "url": "https://bonitasoft.jfrog.io/artifactory/releases",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "false"
                }
              }
            ]
          servers: >
            [
              {
                "id": "bar",
                "username": "${{ secrets.JFROG_USER }}",
                "password": "${{ secrets.JFROG_TOKEN }}"
              },
              {
                "id": "github-presales",
                "username": "${{ secrets.GHP_USER }}",
                "password": "${{ secrets.GHP_TOKEN }}"
              },
              {
                "id": "github-laurent",
                "username": "${{ secrets.GHP_USER }}",
                "password": "${{ secrets.GHP_TOKEN }}"
              }
            ]

      - name: Login to Jfrog
        run: docker login https://bonitasoft.jfrog.io -u ${{ secrets.JFROG_USER }} -p ${{ secrets.JFROG_TOKEN }}

      # comes from create server
      - name: Download artifact instance.yaml file
        uses: actions/download-artifact@v4
        with:
          name: aws_instance

      # comes from pre requisites
      - name: Download artifact instance.yaml file
        uses: actions/download-artifact@v4
        with:
          name: pre_requisites


      - name: read-yaml-instance-file
        uses: pietrobolcato/action-read-yaml@1.1.0
        id: read-yaml-instance-file
        with:
          config: ${{ github.workspace }}/aws_instance.yaml

      - name: read-yaml-requisite-file
        uses: pietrobolcato/action-read-yaml@1.1.0
        id: read-yaml-requisite-file
        with:
          config: ${{ github.workspace }}/pre_requisites.yaml


      - name: set env variables
        id: set-env-variable
        run: |
          echo "AWS_PUBLIC_DNS_HOSTNAME=${{ steps.read-yaml-instance-file.outputs['publicDnsName'] }}" >> $GITHUB_ENV
          echo "IT_FOLDER_EXISTS=${{ steps.read-yaml-requisite-file.outputs['IT_FOLDER_EXISTS'] }}" >> $GITHUB_ENV
          echo "DATAGEN_FOLDER_EXISTS=${{ steps.read-yaml-requisite-file.outputs['DATAGEN_FOLDER_EXISTS'] }}" >> $GITHUB_ENV
          if [ -n "${{ inputs.bonita_dns }}" ]; then
            BONITA_DNS="${{ inputs.bonita_dns }}"
          else
            BONITA_DNS="${{ steps.read-yaml-instance-file.outputs['publicDnsName'] }}"
          fi
          BONITA_PORT="${{ inputs.bonita_port }}"
          BONITA_URL="http://${BONITA_DNS}:${BONITA_PORT}/bonita"
          echo "BONITA_DNS=${BONITA_DNS}" >> $GITHUB_ENV
          echo "BONITA_PORT=${BONITA_PORT}" >> $GITHUB_ENV
          echo "BONITA_URL=${BONITA_URL}" >> $GITHUB_ENV 

      - name: display env variables
        id: display-env-variable
        run: |
          echo "AWS_PUBLIC_DNS_HOSTNAME: [${AWS_PUBLIC_DNS_HOSTNAME}]"
          echo "IT_FOLDER_EXISTS: [${IT_FOLDER_EXISTS}]"
          echo "DATAGEN_FOLDER_EXISTS: [${DATAGEN_FOLDER_EXISTS}]"
          echo "BONITA_DNS: [${BONITA_DNS}]"
          echo "BONITA_PORT: [${BONITA_PORT}]"
          echo "BONITA_URL: [${BONITA_URL}]" 

      - name: run datagen
        if: env.DATAGEN_FOLDER_EXISTS == 'true'
        run: |
          echo "Run data generation"
          ./mvnw --batch-mode --no-transfer-progress clean verify \
          -f ${{ inputs.datagen_folder }}/pom.xml \
          -Dbonita.url=${BONITA_URL} \
          -DSMTP_SERVER=${{ inputs.smtp_server }} \
          -DSMTP_PORT=${{ inputs.smtp_port }} \
          -DSALESFORCE_USERNAME=${{ secrets.SF_USERNAME }} \
          -DSALESFORCE_PASSWORD=${{ secrets.SF_PASSWORD }} \
          -DSALESFORCE_TOKEN=${{ secrets.SF_TOKEN }} \
          -DOPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        
